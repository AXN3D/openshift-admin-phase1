apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: registry.access.redhat.com/ubi9/python-311
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          value: postgres
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRESQL_DATABASE
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRESQL_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRESQL_PASSWORD
        command: ["bash", "-c"]
        args:
          - |
            pip install psycopg2-binary && \
            python - << 'EOF'
            import os, time, psycopg2
            from http.server import HTTPServer, BaseHTTPRequestHandler

            while True:
                try:
                    conn = psycopg2.connect(
                        host=os.environ["DB_HOST"],
                        port=os.environ["DB_PORT"],
                        dbname=os.environ["DB_NAME"],
                        user=os.environ["DB_USER"],
                        password=os.environ["DB_PASSWORD"],
                    )
                    print("Connected to PostgreSQL successfully")
                    break
                except Exception as e:
                    print("DB connection failed:", e)
                    time.sleep(5)

            class Handler(BaseHTTPRequestHandler):
                def do_GET(self):
                    self.send_response(200)
                    self.end_headers()
                    self.wfile.write(b"Backend connected to PostgreSQL")

            HTTPServer(("", 8080), Handler).serve_forever()
            EOF

